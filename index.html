<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Smooth Face & Age Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00bcff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #container { position: relative; border: 4px solid #333; border-radius: 20px; overflow: hidden; line-height: 0; }
        canvas { position: absolute; top: 0; left: 0; }
        #status { margin-bottom: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="status">System Initializing...</div>

    <div id="container">
        <video id="video" width="640" height="480" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const status = document.getElementById('status');
        let ageBuffer = {}; 

        async function startApp() {
            // Check if faceapi loaded correctly
            if (typeof faceapi === 'undefined') {
                status.innerText = "Error: Library not loaded. Check internet.";
                return;
            }

            status.innerText = "Loading AI Brain...";
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
            
            try {
                // Load only what we need for maximum speed
                await Promise.all([
                    faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                    faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
                ]);

                status.innerText = "Requesting Camera...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, frameRate: { ideal: 30 } } 
                });
                video.srcObject = stream;
            } catch (err) {
                status.innerText = "Error: " + err.message;
            }
        }

        video.addEventListener('play', () => {
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);
            status.innerText = "Tracking Active";

            // Optimization: Run detection in a loop that matches your screen refresh rate
            async function loop() {
                const detections = await faceapi.detectAllFaces(
                    video, 
                    new faceapi.TinyFaceDetectorOptions({ inputSize: 160, scoreThreshold: 0.5 })
                ).withAgeAndGender();

                const resized = faceapi.resizeResults(detections, displaySize);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                resized.forEach((det, i) => {
                    const { age, box } = det;

                    // Smooth the age number so it doesn't jump
                    if (!ageBuffer[i]) ageBuffer[i] = [];
                    ageBuffer[i].push(age);
                    if (ageBuffer[i].length > 15) ageBuffer[i].shift();
                    const avgAge = Math.round(ageBuffer[i].reduce((a, b) => a + b) / ageBuffer[i].length);

                    // Draw the Blue Square
                    ctx.strokeStyle = '#00bcff';
                    ctx.lineWidth = 5;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#00bcff';
                    // Draw square slightly higher to sit on the "head"
                    ctx.strokeRect(box.x, box.y - 40, box.width, box.width);

                    // Draw the Age Label
                    ctx.fillStyle = '#00bcff';
                    ctx.font = 'bold 22px Arial';
                    ctx.shadowBlur = 5;
                    ctx.fillText(`AGE: ~${avgAge}`, box.x, box.y - 50);
                });

                requestAnimationFrame(loop); // This makes it much smoother than setInterval
            }

            loop();
        });

        // Fire it up
        startApp();
    </script>
</body>
</html>
