<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>iPad Face Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #000; color: #00bcff; font-family: -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        #container { position: relative; width: 90vw; height: 70vh; background: #111; border-radius: 15px; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #log { position: absolute; bottom: 10px; width: 90%; background: rgba(0,0,0,0.8); padding: 5px; font-size: 10px; color: white; border-radius: 5px; max-height: 100px; overflow-y: auto; pointer-events: none; }
    </style>
</head>
<body>

    <div id="status">INITIALIZING...</div>
    <div id="container">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
        <div id="log">Logs:</div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const status = document.getElementById('status');
        const logBox = document.getElementById('log');

        function logger(msg) {
            const p = document.createElement('div');
            p.innerText = `> ${msg}`;
            logBox.prepend(p);
            console.log(msg);
        }

        async function start() {
            try {
                const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/';
                
                logger("Loading AI Models...");
                await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
                await faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL);
                logger("Models Loaded.");

                logger("Requesting Camera...");
                // iPad prefers simpler constraints
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" } 
                });
                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    logger("Camera Stream Ready.");
                    const displaySize = { width: video.videoWidth, height: video.videoHeight };
                    faceapi.matchDimensions(canvas, displaySize);
                    
                    status.innerText = "TRACKING ACTIVE";
                    detectLoop(displaySize);
                };

            } catch (err) {
                status.innerText = "ERROR OCCURRED";
                logger("FATAL: " + err.message);
            }
        }

        async function detectLoop(displaySize) {
            const ctx = canvas.getContext('2d');
            
            async function loop() {
                // Use a lower threshold (0.2) to be very sensitive
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold: 0.2 })).withAgeAndGender();
                
                const resized = faceapi.resizeResults(detections, displaySize);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (resized.length > 0) {
                    resized.forEach(det => {
                        const { x, y, width, height } = det.box;

                        // Thick Neon Blue Square
                        ctx.strokeStyle = '#00f0ff';
                        ctx.lineWidth = 8;
                        ctx.strokeRect(x, y, width, height);

                        // Age Label
                        ctx.fillStyle = '#00f0ff';
                        ctx.font = 'bold 24px Arial';
                        ctx.fillText(`~${Math.round(det.age)} yrs`, x, y - 15);
                    });
                }
                requestAnimationFrame(loop);
            }
            loop();
        }

        // Start the process
        start();
    </script>
</body>
</html>
