<!DOCTYPE html>
<html>
<head>
    <title>Multi-Face Age Tracker</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        body { margin: 0; background: #111; display: flex; flex-direction: column; align-items: center; color: white; font-family: 'Segoe UI', sans-serif; }
        #canvas-container { position: relative; margin-top: 20px; }
        video, canvas { position: absolute; top: 0; left: 0; border-radius: 10px; }
        .loading { margin-top: 200px; font-size: 20px; color: #00bcff; }
    </style>
</head>
<body>

    <div id="loading" class="loading">Initializing AI Models (Age & Face)...</div>
    
    <div id="canvas-container">
        <video id="video" width="640" height="480" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('overlay');
        const loadingLabel = document.getElementById('loading');

        // This helps stop the age from flickering
        const ageHistory = {}; 

        async function setup() {
            // 1. Load the models from a public CDN
            const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
            
            await Promise.all([
                faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
            ]);

            // 2. Start Video
            navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480 } })
                .then(stream => {
                    video.srcObject = stream;
                    loadingLabel.style.display = 'none';
                });
        }

        video.addEventListener('play', () => {
            const displaySize = { width: video.width, height: video.height };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                // 3. Detect ALL faces + Age
                const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
                    .withFaceLandmarks()
                    .withAgeAndGender();

                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                
                // Clear and draw
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                resizedDetections.forEach((detection, i) => {
                    const { age, box } = detection;
                    
                    // 4. Smooth the age (Average of last 10 frames)
                    if (!ageHistory[i]) ageHistory[i] = [];
                    ageHistory[i].push(age);
                    if (ageHistory[i].length > 15) ageHistory[i].shift();
                    const smoothAge = Math.round(ageHistory[i].reduce((a, b) => a + b) / ageHistory[i].length);

                    // 5. Custom Drawing (Blue Square + Age)
                    ctx.strokeStyle = '#00bcff';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(box.x, box.y - 50, box.width, box.width); // Square on head area

                    ctx.fillStyle = '#00bcff';
                    ctx.font = 'bold 18px Arial';
                    ctx.fillText(`Age: ~${smoothAge}`, box.x, box.y - 60);
                });
            }, 100); // Runs 10 times per second for smoothness
        });

        setup();
    </script>
</body>
</html>
